function WordSearch(e){this.numWords=e.numWords,this.directions=e.directions,this.reversable=e.reversable,this.definitions=[],this.callBack=e.callBack,this.getWords()}function drill(e){for(var r=0;r<(e.results||[]).length;r++)for(var t=e.results[r],o=0;o<(t.senses||[]).length;o++)for(var n=t.senses[o],a=0;a<(n.definition||[]).length;o++){var i=n.definition[a];if(i)return i}}function drawGrid(e){$(".puzzle").remove(),loadStub({parent:".puzzle-container",file:"./stubs/puzzle.html",params:{puzzle:e}})}function drawWordList(e){$(".word-list").remove();var r=deepCopy(e);r.sort(function(e,r){return r.word<e.word}),loadStub({parent:".word-list-container",file:"./stubs/word_list.html",params:{key:r}},function(){$(".words").click(showDefinition);for(var r=0;r<e.length;r++)e[r].selected&&highlightCells({vector:e[r],mode:"add",classes:["selected"]})})}function drawPuzzle(e){drawGrid(e.grid),drawWordList(deepCopy(e.key).sort()),saveLocal()}function getPuzzleRowCol(e,r){var t=($(".puzzle"),$(".puzzle-cell--0-0")),o=Math.floor((r-t.position().top)/(t.height()*mainPuzzle.puzzle.grid.length)*mainPuzzle.puzzle.grid.length),n=Math.floor((e-t.position().left)/(t.height()*mainPuzzle.puzzle.grid.length)*mainPuzzle.puzzle.grid.length);return{row:o,col:n}}function loadStub(e,r){if(e.html){var t=Handlebars.compile(e.html);$(e.parent).append(t(e.params)),r&&r()}else $.get(e.file,function(t){loadStub({html:t,parent:e.parent,params:e.params,blowout:e.blowout},r)});fitPuzzle()}function hideMenu(e){$(".menu-container").animate({top:"-100vh"},400,e),menuDisplayed=!1,$(".cheering").remove()}function showMenu(){$(".menu-container").animate({top:"50px"},400),menuDisplayed=!0}function fitPuzzle(){if(mainPuzzle){var e=$(".puzzle-cell").css("font-size");$(".word-list-container h2").css("font-size","calc(1 * "+e+")"),$(".word-list-container li").css("font-size","calc(0.7 * "+e+")")}}function chomp(e){var r=Array.prototype.filter.call(e.target.classList,function(e){return e.indexOf("--")+1})[0];if(r){var t=r.split("--")[1].split("-");return 2===t.length?{row:parseInt(t[0]),col:parseInt(t[1])}:{}}}function puzzleDown(e){e.preventDefault(),dragTrack={},dragTrack.start=chomp(e)}function puzzleDrag(e){e.preventDefault(),dragTrack&&dragTrack.start&&(dragTrack.end=e.originalEvent.touches?getPuzzleRowCol(e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY):chomp(e),highlightCells({classes:["selecting"],mode:"clear"}),dragTrack=highlightCells({vector:dragTrack,classes:["selecting"],mode:"add"}))}function puzzleUp(e){if(e.preventDefault(),dragTrack&&dragTrack.start&&dragTrack.end)for(var r=mainPuzzle.puzzle.key,t=0;t<r.length;t++)r[t].start.row!==dragTrack.start.row||r[t].start.col!==dragTrack.start.col||r[t].end.row!==dragTrack.end.row||r[t].end.col!==dragTrack.end.col||r[t].selected||(r[t].selected=!0,$("."+r[t].word).addClass("found"),makeCellList(dragTrack),saveLocal(),highlightCells({vector:dragTrack,classes:["selected"],mode:"add"}),t=r.length,isPuzzleFinished())}function highlightCells(e){if("clear"!==e.mode){var r=makeCellList(e.vector);if(r){if(0===r.length)return{};var t={start:{},end:{}};for(t.start.row=r[0][0],t.start.col=r[0][1],t.end.row=r[r.length-1][0],t.end.col=r[r.length-1][1],i=0;i<e.classes.length;i++)for(var o=0;o<r.length;o++){var n=r[o][0],a=r[o][1];"add"===e.mode?$(".puzzle-cell--"+n+"-"+a).addClass(e.classes[i]):$(".puzzle-cell--"+n+"-"+a).removeClass(e.classes[i])}}return t}for(var i=0;i<e.classes.length;i++)$(".puzzle-cell").removeClass(e.classes[i])}function makeCellList(e){function r(e,r){return e>r?-1:e===r?0:1}if(e.start&&e.end){var t=Math.abs(Math.abs(e.start.row)-Math.abs(e.end.row)),o=Math.abs(Math.abs(e.start.col)-Math.abs(e.end.col)),n=Math.max(t,o)+1,a=o/2>t?0:1,i=t/2>o?0:1;a*=r(e.start.row,e.end.row),i*=r(e.start.col,e.end.col);for(var l=[],s=deepCopy(e.start),d=0;n>d;d++)l.push([s.row,s.col]),s.row+=a,s.col+=i;return l}}function saveLocal(){localStorage.wordsearch=JSON.stringify(mainPuzzle),localStorage.diagonal=$(".diagonal")[0].checked,localStorage.backwards=$(".backwards")[0].checked,localStorage["num-words"]=$(".num-words").val()}function isPuzzleFinished(){for(var e=0;e<mainPuzzle.puzzle.key.length;e++)if(!mainPuzzle.puzzle.key[e].selected)return;localStorage.wordsearch="",$(".main").append('<audio autoplay="autoplay" class="cheering nevershown"><source src="./sounds/cheering.mp3" type="audio/mpeg" /></audio>'),popUp("Congratulations! You finished this puzzle!",showMenu)}function popUp(e,r){$(".modal-message").html(e),$(".modal-container").show(),$(".modal-button").focus(),modalCallback=r}function showDefinition(e){var r=e.target.innerText,t=WordSearch.prototype.whatIsDefinition.call(mainPuzzle,r);popUp(r+": "+t)}function blankPuzzle(e,r){for(var t=[],o=0;e>o;o++){for(var n=[],a=0;e>a;a++)n.push(r);t.push(n.slice())}return t}function deepCopy(e){var r=e instanceof Array?[]:{};for(var t in e)"object"==typeof e[t]?r[t]=deepCopy(e[t]):r[t]=e[t];return r}function randomLetter(){var e=Math.floor(26*Math.random());return"ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e]}function resize(e,r,t){for(var o=deepCopy(e);o.length<r;)o.push([]);for(var n=0;n<o.length;n++)for(;o[n].length<r;)o[n].push(t);return o}function stepDirection(e){return"vertical"===e?{rowStep:1,colStep:0}:"diagonal up"===e?{rowStep:-1,colStep:1}:"diagonal down"===e?{rowStep:1,colStep:1}:{rowStep:0,colStep:1}}function insert(e){e=deepCopy(e);for(var r=stepDirection(e.direction),t=deepCopy(e.start),o={row:t.row+r.rowStep*(e.word.length-1),col:t.col+r.colStep*(e.word.length-1)},n={start:e.reverse?o:t,end:e.reverse?t:o,word:e.word,reverse:!!e.reverse},a=0;a<e.word.length;a++){var i=e.grid[e.start.row][e.start.col],l=e.reverse?e.word[e.word.length-(a+1)].toUpperCase():e.word[a].toUpperCase();if("-"===i)e.grid[e.start.row][e.start.col]=l;else if(i!==l)return!1;e.start.row+=r.rowStep,e.start.col+=r.colStep}return{grid:e.grid,key:n}}function fillRandom(e){for(var r=deepCopy(e),t=0;t<r.length;t++)for(var o=0;o<r[t].length;o++)"-"===r[t][o]&&(r[t][o]=randomLetter());return r}function range(e,r,t){for(var o=[],n=e;n<r+(Number(t)||0);n++)o.push(n);return o}function combinationRanges(e,r,t){for(var o=[],n=0;n<e.length;n++)for(var a=0;a<r.length;a++)o.push({row:e[n],col:r[a],direction:t});return o}function getMatrix(e,r,t){var o="diagonal up"===t?r.length-1:0,n=0,a="horizontal"===t||"diagonal up"===t?e.length-1:e.length-r.length,i="vertical"===t?e.length-1:e.length-r.length;return combinationRanges(range(o,a,!0),range(n,i,!0),t)}function concatMatrices(e,r,t,o){for(var n=[],a=0;a<t.length;a++)n=o?n.concat(getMatrix(e,r,t[a]).randomize()):n.concat(getMatrix(e,r,t[a]));return n}function addWord(e){for(var r=!1,t=e.grid;!r;){t=resize(t,e.word.length+1,"-");for(var o=concatMatrices(t,e.word,e.directions.shuffle(),!0),n=0;n<o.length;n++){var a=insert({start:{row:o[n].row,col:o[n].col},direction:o[n].direction,word:e.word,grid:t,reverse:e.reversable?Math.floor(2.2*Math.random()):!1});a&&(r=!0,t=a.grid,n=o.length,e.key.push(a.key))}r||(t=resize(t,t.length+1,"-"))}return{grid:t,key:e.key}}function makePuzzle(e){var r=e.words.sort(function(e,r){return r.length-e.length}),t={};e.directions.sort();for(var o=0;o<r.length;o++)t=addWord({grid:t.grid||[],key:t.key||[],directions:e.directions,word:r[o],reversable:e.reversable});return{grid:fillRandom(t.grid),key:t.key}}WordSearch.prototype.addDefinition=function(e,r){for(var t=0;t<this.definitions.length;t++)this.definitions[t].word===e&&(this.definitions[t].definition=r,t=this.definitions.length)},WordSearch.prototype.getDefinition=function(e){var r=this,t={},o=drill(t)||"no definition found";r.addDefinition(e,o)},WordSearch.prototype.whatIsDefinition=function(e){for(var r=0;r<this.definitions.length;r++)if(e===this.definitions[r].word)return this.definitions[r].definition||"definition look-up in progress...";return"broken"},WordSearch.prototype.newPuzzle=function(){this.puzzle=makePuzzle({directions:this.directions,reversable:this.reversable,words:this.definitions.map(function(e){return e.word})});for(var e=0;e<this.puzzle.key.length;e++)for(var r=0;r<this.definitions.length;r++)this.definitions[r].word===this.puzzle.key[e].word&&(this.puzzle.key[e].definition=this.definitions[r].definition,r=this.definitions.length);this.callBack(this.puzzle)},WordSearch.prototype.getWords=function(){var e=new XMLHttpRequest,r=this;e.onreadystatechange=function(){if(200===this.status&&4===this.readyState)for(var e=JSON.parse(this.responseText).words,t=[];t.length<r.numWords;){var o=Math.floor(Math.random()*e.length);-1===t.indexOf(e[o])&&(t.push(e[o]),r.definitions.push({word:e[o]}),r.getDefinition(e[o]),t.length===r.numWords&&r.newPuzzle())}},e.open("GET","/words.json"),e.send()};var mainPuzzle,dragTrack={},minWordCount=10,maxWordCount=50,menuDisplayed=!1,modalCallback;$(function(){$(".menu-button").click(function(e){e.preventDefault(),menuDisplayed?window.hideMenu():window.showMenu()}),$(".diagonal")[0].checked="true"===localStorage.diagonal?!0:!1,$(".backwards")[0].checked="true"===localStorage.backwards?!0:!1,$(".num-words").val(localStorage["num-words"]||"15");var e=localStorage.wordsearch;e?(mainPuzzle=JSON.parse(e),drawPuzzle(mainPuzzle.puzzle)):$(".menu-button").click(),$(".puzzle-container").on("mousedown touchstart",puzzleDown).on("mousemove touchmove",puzzleDrag).on("mouseup touchend",puzzleUp),$(".submit-form").click(function(e){e.preventDefault();var r=$(".diagonal").is(":checked")?["diagonal up","diagonal down"]:[],t=["horizontal","vertical"].concat(r),o=$(".backwards").is(":checked"),n=parseInt($(".num-words").val());isNaN(n)||minWordCount>n||n>maxWordCount?popUp("The number of words must be a number between "+minWordCount+" and "+maxWordCount+"!"):($(".puzzle-container").html('<p class="puzzle">Loading new puzzle...</p>'),hideMenu(function(){mainPuzzle=new WordSearch({directions:t,numWords:n,reversable:o,callBack:drawPuzzle})}))}),$(".puzzle-options").on("keypress",function(e){13===e.keyCode&&e.preventDefault(),$(".submit-form")[0].click()}),$(".modal-button").on("click",function(e){e.preventDefault(),$(".modal-container").hide(),modalCallback&&modalCallback(),modalCallback=null})}),window.onresize=fitPuzzle,$(document).on("mouseup touchend",function(e){highlightCells({classes:["selecting"],mode:"clear"}),dragTrack={}}),Array.prototype.randomize=function(){return this.sort(function(){return Math.floor(2*Math.random())?-1:1}),this},Array.prototype.shuffle=function(){return this.push(this.shift()),this};var module=module||{};module.exports={blankPuzzle:blankPuzzle,deepCopy:deepCopy,randomLetter:randomLetter,resize:resize,stepDirection:stepDirection,insert:insert,fillRandom:fillRandom,range:range,combinationRanges:combinationRanges,concatMatrices:concatMatrices,getMatrix:getMatrix};